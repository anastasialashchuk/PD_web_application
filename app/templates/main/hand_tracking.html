<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Hand Tracking Recorder</title>
    <style>
        /* –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        nav {
            background-color: #2c3e50;
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        nav a:hover {
            background-color: #3498db;
        }

        nav a.active {
            background-color: #2980b9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: #000;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #processedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        #autoRecordToggle {
            background: #9b59b6;
        }
        #autoRecordToggle:hover:not(:disabled) {
            background: #8e44ad;
        }
        #autoRecordToggle.active {
            background: #2ecc71;
        }
        #saveButton {
            background: #f39c12;
            display: none;
        }
        #saveButton:hover:not(:disabled) {
            background: #e67e22;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
            vertical-align: middle;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .settings {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .settings label {
            display: block;
            margin-bottom: 8px;
        }
        .settings input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }
        .settings-value {
            float: right;
            font-weight: bold;
        }
        .file-info {
            margin-top: 10px;
            font-family: monospace;
            word-break: break-all;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        .data-info {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav>
            <a href="/" class="active">Home</a>
            <a href="/processing">Process Recordings</a>
        </nav>

        <h1>üëã Auto Hand Tracking Recorder</h1>

        <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <img id="processedImage" alt="Processed Output">
        </div>

        <div class="controls">
            <button id="startButton">Start Camera</button>
            <button id="autoRecordToggle" disabled>Enable Auto-Record</button>
            <button id="saveButton" disabled>Save Recording</button>
        </div>

        <div class="settings">
            <h3>Settings</h3>
            <label>
                Hand Detection Confidence:
                <input type="range" id="confidenceSlider" min="0.1" max="1.0" step="0.1" value="0.6">
                <span class="settings-value" id="confidenceValue">0.6</span>
            </label>
            <label>
                Recording Delay (seconds):
                <input type="range" id="delaySlider" min="1" max="5" step="0.5" value="2.0">
                <span class="settings-value" id="delayValue">2.0</span>
            </label>
        </div>

        <div class="status" id="statusMessage">
            Click "Start Camera" to begin
        </div>
        <div id="fileInfo" class="file-info"></div>
        <div id="dataInfo" class="data-info"></div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const processedImage = document.getElementById('processedImage');
        const startButton = document.getElementById('startButton');
        const autoRecordToggle = document.getElementById('autoRecordToggle');
        const saveButton = document.getElementById('saveButton');
        const statusMessage = document.getElementById('statusMessage');
        const fileInfo = document.getElementById('fileInfo');
        const dataInfo = document.getElementById('dataInfo');
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceValue = document.getElementById('confidenceValue');
        const delaySlider = document.getElementById('delaySlider');
        const delayValue = document.getElementById('delayValue');

        let stream = null;
        let isProcessing = false;
        let autoRecordEnabled = false;
        let processingInterval = null;
        let currentSettings = {
            confidence: 0.6,
            delay: 2.0
        };
        let handData = [];

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
        confidenceSlider.addEventListener('input', (e) => {
            currentSettings.confidence = parseFloat(e.target.value);
            confidenceValue.textContent = currentSettings.confidence.toFixed(1);
        });

        delaySlider.addEventListener('input', (e) => {
            currentSettings.delay = parseFloat(e.target.value);
            delayValue.textContent = currentSettings.delay.toFixed(1);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus("System ready. Click 'Start Camera' to begin.");

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            const currentPath = window.location.pathname;
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === currentPath);
            });
        });

        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        startButton.addEventListener('click', async () => {
            try {
                startButton.disabled = true;
                updateStatus("Starting camera...");

                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    },
                    audio: false
                });

                video.srcObject = stream;
                autoRecordToggle.disabled = false;
                updateStatus("Camera active. Enable Auto-Record to start.");
            } catch (err) {
                console.error("Camera error:", err);
                startButton.disabled = false;
                updateStatus("Error accessing camera: " + err.message, true);
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ-–∑–∞–ø–∏—Å—å—é
        autoRecordToggle.addEventListener('click', () => {
            autoRecordEnabled = !autoRecordEnabled;

            if (autoRecordEnabled) {
                autoRecordToggle.classList.add('active');
                autoRecordToggle.textContent = "Disable Auto-Record";
                startProcessing();
                updateStatus("Auto-Record enabled. Show your hand to start recording.");
            } else {
                autoRecordToggle.classList.remove('active');
                autoRecordToggle.textContent = "Enable Auto-Record";
                stopProcessing();
                updateStatus("Auto-Record disabled.");
            }
        });

        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        saveButton.addEventListener('click', async () => {
            try {
                saveButton.disabled = true;
                updateStatus("Saving recording and hand data...");

                const response = await fetch('/save_recording', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        hand_data: handData
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    updateStatus(`Recording saved successfully! ${data.frame_count} frames.`);
                    fileInfo.textContent = `Saved to: ${data.saved_path}`;
                    fileInfo.style.display = 'block';
                    saveButton.style.display = 'none';
                    handData = []; // Clear saved data
                } else {
                    throw new Error(data.message || "Failed to save recording");
                }
            } catch (error) {
                console.error("Save error:", error);
                saveButton.disabled = false;
                updateStatus("Error saving recording: " + error.message, true);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, isError = false) {
            statusMessage.innerHTML = message;
            if (isError) {
                statusMessage.style.color = '#e74c3c';
            } else {
                statusMessage.style.color = '#2c3e50';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–∏—Å–∏
        function addRecordingIndicator() {
            if (!statusMessage.innerHTML.includes('recording-indicator')) {
                statusMessage.innerHTML = `<span class="recording-indicator"></span> ${statusMessage.innerHTML}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–∏—Å–∏
        function removeRecordingIndicator() {
            statusMessage.innerHTML = statusMessage.innerHTML.replace('<span class="recording-indicator"></span> ', '');
        }

        // –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–æ–≤
        function startProcessing() {
            if (processingInterval) clearInterval(processingInterval);

            processingInterval = setInterval(async () => {
                if (!stream || isProcessing) return;

                isProcessing = true;

                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const imageData = canvas.toDataURL('image/jpeg');
                    const response = await fetch('/process_frame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Confidence': currentSettings.confidence,
                            'X-Delay': currentSettings.delay
                        },
                        body: JSON.stringify({image: imageData})
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        video.style.display = 'none';
                        processedImage.style.display = 'block';
                        processedImage.src = data.processed_image;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä—É–∫–∞—Ö
                        if (data.hand_data && data.hand_data.length > 0) {
                            handData = handData.concat(data.hand_data);
                            updateHandDataDisplay(data.hand_data);
                        }

                        if (data.is_recording) {
                            addRecordingIndicator();
                            updateStatus(`Recording... Frames: ${data.frame_count}`);
                            saveButton.style.display = 'inline-block';
                            saveButton.disabled = false;
                            fileInfo.textContent = `Temp file: ${data.output_file}`;
                            fileInfo.style.display = 'block';
                        } else {
                            removeRecordingIndicator();
                            if (autoRecordEnabled) {
                                updateStatus("Waiting for hand detection...");
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                } finally {
                    isProcessing = false;
                }
            }, 100); // –û–±—Ä–∞–±–æ—Ç–∫–∞ ~10 FPS –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ä—É–∫–∞—Ö
        function updateHandDataDisplay(newData) {
            let displayText = '';
            newData.forEach(frame => {
                displayText += `Frame ${frame.frame}:\n`;
                for (const [hand, points] of Object.entries(frame)) {
                    if (hand !== 'frame') {
                        displayText += `  ${hand}:\n`;
                        for (const [point, coords] of Object.entries(points)) {
                            displayText += `    ${point}: X=${coords.X}, Y=${coords.Y}, Z=${coords.Z}\n`;
                        }
                    }
                }
                displayText += '\n';
            });
            dataInfo.textContent = displayText;
            dataInfo.scrollTop = dataInfo.scrollHeight;
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–æ–≤
        function stopProcessing() {
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }
            removeRecordingIndicator();
            saveButton.style.display = 'none';
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            stopProcessing();
        });

    </script>
</body>
</html>